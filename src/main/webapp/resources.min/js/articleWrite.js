"use strict";const articleEditor=document.querySelector("#article-editor"),quill=new Quill(articleEditor,{theme:"bubble",placeholder:"Напишите о чём нибудь интересном",fontSize:"25",modules:{toolbar:[[{size:["small",!1,"large","huge"]}],["bold","italic","underline","strike"],["direction",{align:["","center","right","justify"]}],["code-block","blockquote",{list:"ordered"},{list:"bullet"}],["link","image"]]}}),images={imageHover:document.querySelector("#image-hover"),topImageSection:document.querySelector(".head-info .card-image"),uploadMainImage:document.querySelector("#uploadMainImage")},inputs={titleInput:document.querySelector("#title"),subtitleInput:document.querySelector("#subtitle"),tagsObjects:tags.tagsCount,qlEditor:document.querySelector(".ql-editor"),mainImage:document.querySelector(".head-info .card-image img"),edit:!0};function initIfEdit(){if(null===document.getElementById("_edit"))return void(inputs.edit=!1);inputs.articleId=document.getElementById("article_id").getAttribute("content");let e=document.getElementById("title_edit"),t=document.getElementById("subtitle_edit"),i=document.getElementById("tags_edit"),l=i.children,a=document.getElementById("article_edit"),o=document.getElementById("image_edit");inputs.titleInput.value=e.innerText,inputs.subtitleInput.value=t.innerText,l.length>0&&(tags.tagLabel.style.top="-14px",tags.tagLabel.style.fontSize="12px");for(let e=0;e<l.length;e++){let t=l[e],i=document.createElement("div"),a=t.getAttribute("name"),o=t.getAttribute("color"),r=t.getAttribute("content");i.classList.add("selected-tag","chip"),i.style.background=o,i.innerText=a,i.style.color="#ffffff",i.setAttribute("content",r),i.addEventListener("click",deleteTagOnClick),tags.tagsCount[r]=1,tags.tagsInputContainer.insertBefore(i,tags.tagsInputContainer.lastElementChild)}inputs.qlEditor.innerHTML=a.innerHTML.trim(),inputs.mainImage.src="/"+o.getAttribute("largeImagePath"),images.smallImagePath=o.getAttribute("smallImagePath"),images.middleImagePath=o.getAttribute("middleImagePath"),images.largeImagePath=o.getAttribute("largeImagePath"),e.parentNode.removeChild(e),t.parentNode.removeChild(t),i.parentNode.removeChild(i),a.parentNode.removeChild(a),o.parentNode.removeChild(o)}const qlToolbar=articleEditor.querySelector(".ql-tooltip"),qlToolbarArrow=qlToolbar.querySelector(".ql-tooltip-arrow"),editor={isShow:!1,qlToolbarWidth:0,articleEditorWidth:articleEditor.clientWidth,showToolbar:function(e,t){let i=articleEditor.getBoundingClientRect(),l=editor.articleEditorWidth/2-editor.qlToolbarWidth/2,a=i.top;qlToolbar.style.left=l+"px",qlToolbar.style.top=t-a+"px",qlToolbarArrow.style.marginLeft=0,qlToolbar.classList.remove("ql-editing"),qlToolbar.classList.remove("ql-hidden"),editor.isShow=!0},hideToolbar:function(){qlToolbar.classList.add("ql-hidden"),editor.isShow=!1}};function initEditor(){qlToolbar.classList.remove("ql-hidden"),editor.qlToolbarWidth=qlToolbar.clientWidth,qlToolbar.classList.add("ql-hidden"),articleEditor.addEventListener("click",function(e){editor.isShow?editor.hideToolbar():editor.showToolbar(e.clientX,e.clientY)}),qlToolbar.addEventListener("click",function(e){e.stopPropagation()})}function initImageManager(){images.topImageSection.onmouseenter=function(e){images.imageHover.style.display="flex"},images.topImageSection.onmouseleave=function(e){images.imageHover.style.display="none"},images.uploadMainImage.onchange=function(e){let t=new FormData;t.append("file",images.uploadMainImage.files[0]),xhr.request({path:"/upload",method:"POST",headers:{"Upload-Type":"article.main"},content:t},function(e,t){if(e){let t=JSON.parse(e);images.smallImagePath=t.small,images.middleImagePath=t.middle,images.largeImagePath=t.large,inputs.mainImage.src="/"+t.large}else t&&modal.error("Не удалось загрузить файл")})}}let creating=!1;function initCreate(){document.querySelector(".create-article").addEventListener("click",function(e){if(creating)return;let t=inputs.qlEditor.innerHTML,i=quill.getText(),l=Object.keys(inputs.tagsObjects);if(inputs.titleInput.value.length>100||inputs.titleInput.value.length<10)return void modal.error("Длина заголовка должна быть больше 10 и не превышать 100 символов");if(!inputs.titleInput.value.match(/^[А-я|Ё|ё|\w|\s|\d|.|,|:|-]+$/))return void modal.error("Заголовок может содержать только буквы, цифры и знаки препинания");if(inputs.subtitleInput.length<10||inputs.subtitleInput.length>100)return void modal.error("Длина подзаголовка должна быть больше 10 и не превышать 100 символов");if(!inputs.subtitleInput.value.match(/^[А-я|Ё|ё|\w|\s|\d|.|,|:|-]+$/))return void modal.error("Подзаголовок может содержать только буквы, цифры и знаки препинания");if(l.length<2||l.length>5)return void modal.error("Количество тегов должно быть больше 2-х и меньше 5-ти");if(i.length<1e3||i.length>1e5)return void modal.error("Длина статьи должна быть больше 1000 символов, но меньше 100000 символов");if(void 0===images.smallImagePath||void 0===images.middleImagePath||void 0===images.largeImagePath)return void modal.error("Не удалось загрузить изображение");creating=!0;const a={title:inputs.titleInput.value,subtitle:inputs.subtitleInput.value,tags:l,htmlContent:t,smallImagePath:images.smallImagePath,middleImagePath:images.middleImagePath,largeImagePath:images.largeImagePath};inputs.edit?updateArticle(a):createArticle(a)})}function createArticle(e){modal.load("Идёт создание статьи..."),xhr.request({path:"/services/articles",method:"POST",headers:{"Content-Type":"application/json"},content:JSON.stringify(e)},function(e,t){if(e){let t=JSON.parse(e);window.location.href="http://localhost/articles/"+t.id}else t&&modal.error("Не удалось создать статью");creating=!1})}function updateArticle(e){e.articleId=inputs.articleId,modal.load("Идёт обновление статьи..."),xhr.request({path:"/services/articles",method:"PUT",headers:{"Content-Type":"application/json"},content:JSON.stringify(e)},function(e,t){e?window.location.href="http://localhost:80/articles/"+inputs.articleId:t&&modal.error("Не удалось обновить статью"),creating=!1})}initTags(),initIfEdit(),initEditor(),initImageManager(),initCreate();